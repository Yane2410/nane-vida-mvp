// ========================================
// NANE VIDA - Prisma Schema
// ========================================
// Compatible con PostgreSQL, MySQL, SQLite
// Para cambiar de base de datos, modifica el provider

generator client {
  provider             = "prisma-client-py"
  interface            = "asyncio"
  recursive_type_depth = 5
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ========================================
// User Management (Django Auth Compatible)
// ========================================
model User {
  id           Int       @id @default(autoincrement())
  username     String    @unique @db.VarChar(150)
  email        String    @unique @db.VarChar(254)
  password     String    @db.VarChar(128)
  firstName    String    @map("first_name") @db.VarChar(150)
  lastName     String    @map("last_name") @db.VarChar(150)
  isActive     Boolean   @default(true) @map("is_active")
  isStaff      Boolean   @default(false) @map("is_staff")
  isSuperuser  Boolean   @default(false) @map("is_superuser")
  dateJoined   DateTime  @default(now()) @map("date_joined")
  lastLogin    DateTime? @map("last_login")
  
  // Relaciones
  entries      Entry[]
  outstandingTokens OutstandingToken[]
  
  @@map("auth_user")
  @@index([email])
  @@index([username])
}

// ========================================
// Core Application Models
// ========================================

// Modelo de Entrada de Diario
model Entry {
  id        Int      @id @default(autoincrement())
  title     String   @db.VarChar(120)
  content   String   @db.Text
  emoji     String   @default("") @db.VarChar(10)
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  
  // Relaci贸n con User
  ownerId   Int      @map("owner_id")
  owner     User     @relation(fields: [ownerId], references: [id], onDelete: Cascade)
  
  @@map("core_entry")
  @@index([ownerId])
  @@index([createdAt])
}

// Modelo de Recursos SOS
model SOSResource {
  id       Int     @id @default(autoincrement())
  title    String  @db.VarChar(120)
  type     String  @default("LINK") @db.VarChar(10)
  url      String  @default("") @db.VarChar(200)
  priority Int     @default(1)
  active   Boolean @default(true)
  
  @@map("core_sosresource")
  @@index([active])
  @@index([priority])
}

// ========================================
// JWT Token Blacklist (SimpleJWT Compatible)
// ========================================

model OutstandingToken {
  id        BigInt   @id @default(autoincrement())
  token     String   @db.Text
  createdAt DateTime? @map("created_at")
  expiresAt DateTime  @map("expires_at")
  jti       String   @unique @db.VarChar(255)
  
  // Relaci贸n con User
  userId    Int?     @map("user_id")
  user      User?    @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Relaci贸n con BlacklistedToken
  blacklistedToken BlacklistedToken?
  
  @@map("token_blacklist_outstandingtoken")
  @@index([userId])
  @@index([jti])
}

model BlacklistedToken {
  id            BigInt   @id @default(autoincrement())
  blacklistedAt DateTime @default(now()) @map("blacklisted_at")
  
  // Relaci贸n con OutstandingToken
  tokenId       BigInt           @unique @map("token_id")
  token         OutstandingToken @relation(fields: [tokenId], references: [id], onDelete: Cascade)
  
  @@map("token_blacklist_blacklistedtoken")
}

// ========================================
// Django Session (Opcional)
// ========================================

model Session {
  sessionKey  String   @id @map("session_key") @db.VarChar(40)
  sessionData String   @map("session_data") @db.Text
  expireDate  DateTime @map("expire_date")
  
  @@map("django_session")
  @@index([expireDate])
}
